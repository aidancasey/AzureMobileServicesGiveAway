var SendGrid = require('sendgrid').SendGrid;


function insert(item, user, request) {
    request.execute({
        success: function() {
            request.respond();
            sendNotifications();
            sendEmail(item);
        }
    });

function sendEmail(item) {
    var sendgrid = new SendGrid('azure_961495bd9b8317462490ad1ff672c3b7@azure.com', 'wi9gvrwz');       


    sendgrid.send({
        to: 'aidancasey@gmail.com',
        from: 'notifications@mtugireland.azure-mobile.net',
        subject: 'New to-do item',
        text: 'A new to-do was added: ' + item.Comment
    }, function(success, message) {
        // If the email failed to send, log it as an error so we can investigate
        if (!success) {
            console.error(message);
        }
    });
}


function sendNotifications() {
    var channelTable = tables.getTable('ClientNotificationChannel');
    channelTable.read({
        success: function(channels) {
            channels.forEach(function(channel) {
                push.wns.sendToastText04(channel.uri, {
                    text1: item.Comment
                }, {
                    success: function(pushResponse) {
                        console.log("Sent push:", pushResponse);
                    }
                });
            });
        }
    });
}


}